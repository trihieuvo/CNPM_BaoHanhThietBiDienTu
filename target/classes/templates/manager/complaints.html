<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Khiếu nại</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS cho Modal */
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeIn 0.3s; }
        .modal-content { background-color: #fff; margin: 8% auto; padding: 30px; width: 90%; max-width: 700px; border-radius: 12px; position: relative; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        @keyframes fadeIn { from {opacity: 0; transform: translateY(-20px);} to {opacity: 1; transform: translateY(0);} }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; font-size: 1.5em; }
        .close-btn { color: #aaa; font-size: 32px; font-weight: bold; cursor: pointer; }
        .modal-body strong { color: var(--text-secondary); min-width: 120px; display: inline-block; }
        #modal-noidung { background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 10px; white-space: pre-wrap; border: 1px solid var(--border-color); }

        /* CSS cho Phân trang */
        .pagination { display: flex; justify-content: center; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color); }
        .pagination a, .pagination span { margin: 0 4px; padding: 8px 16px; border: 1px solid var(--border-color); text-decoration: none; color: var(--text-secondary); border-radius: 6px; }
        .pagination .active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .pagination .disabled { color: #cbd5e1; pointer-events: none; }
    </style>
</head>
<body>
    <div th:replace="~{manager/fragments :: sidebar(activePage='complaints')}"></div>

    <div class="main-content">
        <h1>Quản lý Khiếu nại</h1>

        <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
        
        <div class="card">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Mã KN</th>
                        <th>Khách hàng</th>
                        <th>Về Phiếu Sửa</th>
                        <th>Tiêu đề</th>
                        <th>Ngày gửi</th>
                        <th>Trạng thái</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:if="${complaintPage.empty}">
                        <td colspan="7" style="text-align: center; padding: 40px 0;">Không có khiếu nại nào.</td>
                    </tr>
                    <tr th:each="kn : ${complaintPage.content}" class="complaint-row"
                        th:data-id="${kn.maKhieuNai}"
                        th:data-tieude="${kn.tieuDe}"
                        th:data-ngaygui="${#temporals.format(kn.ngayGui, 'dd-MM-yyyy HH:mm')}"
                        th:data-trangthai="${kn.trangThai}"
                        th:data-maphieu="${kn.phieuSuaChua.maPhieu}"
                        th:data-khachhang="${kn.khachHang.hoTen}"
                        th:data-noidung="${kn.noiDung}">
                        <td><strong th:text="${kn.maKhieuNai}"></strong></td>
                        <td th:text="${kn.khachHang.hoTen}"></td>
                        <td><a th:href="@{/manager/tickets(keyword=${kn.phieuSuaChua.maPhieu})}" class="link" th:text="|#${kn.phieuSuaChua.maPhieu}|"></a></td>
                        <td th:text="${kn.tieuDe}"></td>
                        <td th:text="${#temporals.format(kn.ngayGui, 'dd-MM-yyyy')}"></td>
                        <td>
                            <span class="badge" th:classappend="${kn.trangThai == 'Đã giải quyết'} ? 'badge-success' : (${kn.trangThai == 'Đang xử lý'} ? 'badge-warning' : 'badge-info')" th:text="${kn.trangThai}"></span>
                        </td>
                        <td><a href="#" class="link view-details-btn">Xem & Xử lý →</a></td>
                    </tr>
                </tbody>
            </table>

            <div th:if="${complaintPage.totalPages > 1}" class="pagination">
                <a th:href="@{/manager/complaints(page=0)}" th:classappend="${complaintPage.first} ? 'disabled' : ''">« Đầu</a>
                <a th:href="@{/manager/complaints(page=${complaintPage.number - 1})}" th:classappend="${complaintPage.first} ? 'disabled' : ''">‹ Trước</a>
                <span th:text="${complaintPage.number + 1} + ' / ' + ${complaintPage.totalPages}"></span>
                <a th:href="@{/manager/complaints(page=${complaintPage.number + 1})}" th:classappend="${complaintPage.last} ? 'disabled' : ''">Sau ›</a>
                <a th:href="@{/manager/complaints(page=${complaintPage.totalPages - 1})}" th:classappend="${complaintPage.last} ? 'disabled' : ''">Cuối »</a>
            </div>
        </div>
    </div>

    <div id="details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Chi tiết Khiếu nại</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <p><strong>Mã khiếu nại:</strong> <span id="modal-id"></span></p>
                <p><strong>Khách hàng:</strong> <span id="modal-khachhang"></span></p>
                <p><strong>Về phiếu sửa:</strong> <a id="modal-maphieu-link" href="#" class="link">#<span id="modal-maphieu"></span></a></p>
                <p><strong>Ngày gửi:</strong> <span id="modal-ngaygui"></span></p>
                <p><strong>Tiêu đề:</strong> <span id="modal-tieude"></span></p>
                <p><strong>Nội dung:</strong></p>
                <div id="modal-noidung"></div>
                <hr style="margin: 25px 0;">
                
                <form th:action="@{/manager/complaints/update-status}" method="post">
                    <input type="hidden" id="complaintId" name="complaintId">
                    <div class="form-group">
                        <label for="status-select">Cập nhật trạng thái:</label>
                        <select id="status-select" name="status" class="form-control">
                            <option value="Mới">Mới</option>
                            <option value="Đang xử lý">Đang xử lý</option>
                            <option value="Đã giải quyết">Đã giải quyết</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Cập nhật</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('details-modal');
            const closeBtn = document.querySelector('.close-btn');

            function openModal() { modal.style.display = 'block'; }
            function closeModal() { modal.style.display = 'none'; }

            document.querySelectorAll('.view-details-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const row = this.closest('.complaint-row');
                    const data = row.dataset;

                    document.getElementById('modal-title').innerText = `Chi tiết Khiếu nại #${data.id}`;
                    document.getElementById('modal-id').innerText = data.id;
                    document.getElementById('modal-khachhang').innerText = data.khachhang;
                    document.getElementById('modal-ngaygui').innerText = data.ngaygui;
                    document.getElementById('modal-maphieu').innerText = data.maphieu;
                    document.getElementById('modal-maphieu-link').href = `/manager/tickets?keyword=${data.maphieu}`;
                    document.getElementById('modal-tieude').innerText = data.tieude;
                    document.getElementById('modal-noidung').innerText = data.noidung;
                    
                    // Cập nhật form
                    document.getElementById('complaintId').value = data.id;
                    document.getElementById('status-select').value = data.trangthai;

                    openModal();
                });
            });

            closeBtn.onclick = closeModal;
            window.onclick = function(event) { if (event.target == modal) closeModal(); }
        });
    </script>
</body>
</html>