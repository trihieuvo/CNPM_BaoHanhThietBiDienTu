<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Theo dõi Tiến độ Phiếu sửa</title>
    <link rel="stylesheet" th:href="@{/css/manager-style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .stat-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { flex: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; border-left: 4px solid #007bff; }
        .stat-card h3 { margin: 0 0 10px; color: #6c757d; font-size: 1em; font-weight: 600; }
        .stat-card p { margin: 0; font-size: 2em; font-weight: bold; color: #343a40; }
        
        .stat-card.new { border-color: #17a2b8; }
        .stat-card.in-progress { border-color: #ffc107; }
        .stat-card.waiting { border-color: #fd7e14; }
        .stat-card.completed { border-color: #28a745; }
        .stat-card.late { border-color: #dc3545; }
    </style>
</head>
<body>
    <div th:replace="~{manager/fragments :: sidebar(activePage='tickets')}"></div>

    <div class="main-content">
        <h1>Theo dõi Tiến độ Phiếu sửa</h1>
        
        <div class="stat-cards">
            <div class="stat-card new"><h3>Mới tiếp nhận</h3><p th:text="${ticketStats.moiTiepNhan}">0</p></div>
            <div class="stat-card in-progress"><h3>Đang sửa chữa</h3><p th:text="${ticketStats.dangSuaChua}">0</p></div>
            <div class="stat-card waiting"><h3>Chờ linh kiện</h3><p th:text="${ticketStats.choLinhKien}">0</p></div>
            <div class="stat-card completed"><h3>Đã hoàn thành</h3><p th:text="${ticketStats.daHoanThanh}">0</p></div>
            <div class="stat-card late"><h3>Trễ hẹn</h3><p th:text="${ticketStats.treHen}">0</p></div>
        </div>

        <form th:action="@{/manager/tickets}" method="get" class="toolbar">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" name="keyword" th:value="${keyword}" placeholder="Tìm theo mã phiếu, khách hàng, model...">
            </div>

            <div class="toolbar-actions" style="display: flex; gap: 15px; align-items: center;">
                <div class="filter-dropdown">
                     <select name="status" onchange="this.form.submit()">
                        <option value="">(Tất cả trạng thái)</option>
                        <option value="Mới tiếp nhận" th:selected="${currentStatus == 'Mới tiếp nhận'}">Mới tiếp nhận</option>
                        <option value="Đang sửa chữa" th:selected="${currentStatus == 'Đang sửa chữa'}">Đang sửa chữa</option>
                        <option value="Chờ linh kiện" th:selected="${currentStatus == 'Chờ linh kiện'}">Chờ linh kiện</option>
                        <option value="Đã sửa xong" th:selected="${currentStatus == 'Đã sửa xong'}">Đã sửa xong</option>
                        <option value="Đã trả khách" th:selected="${currentStatus == 'Đã trả khách'}">Đã trả khách</option>
                    </select>
                </div>

                <button type="submit" class="btn-primary">Tìm</button>
            </div>
        </form>

        <table class="data-table">
            <thead>
                <tr>
                    <th>Mã phiếu</th>
                    <th>Khách hàng</th>
                    <th>Thiết bị</th>
                    <th>KTV Phụ trách</th>
                    <th>Ngày Tiếp Nhận</th>
                    <th>Ngày Hẹn Trả</th>
                    <th>Trạng Thái</th>
                    <th>Hành Động</th>
                </tr>
            </thead>
            <tbody>
                <tr th:if="${phieuSuaChuaList.isEmpty()}">
                    <td colspan="8" style="text-align: center;">Không có phiếu sửa chữa nào.</td>
                </tr>
                <tr th:each="phieu : ${phieuSuaChuaList}">
                    <td th:text="${phieu.maPhieu}">Mã phiếu</td>
                    <td th:text="${phieu.khachHang?.hoTen}">Khách hàng</td>
                    <td th:text="${phieu.thietBi?.model}">Thiết bị</td>
                    <td th:text="${phieu.kyThuatVien?.hoTen} ?: 'Chưa gán'">KTV</td>
                    <td th:text="${phieu.ngayTiepNhan != null ? #temporals.format(phieu.ngayTiepNhan, 'dd-MM-yyyy') : ''}">Ngày nhận</td>
                    <td th:text="${phieu.ngayTraDuKien != null ? #temporals.format(phieu.ngayTraDuKien, 'dd-MM-yyyy') : ''}">Ngày hẹn</td>
                    <td th:text="${phieu.trangThai}">Trạng Thái</td>
                    <td class="action-buttons">
                        <a th:href="@{/technician/cong-viec/{id}(id=${phieu.maPhieu})}" title="Xem chi tiết">
                            <i class="fas fa-eye"></i>
                        </a>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

</body>
</html>