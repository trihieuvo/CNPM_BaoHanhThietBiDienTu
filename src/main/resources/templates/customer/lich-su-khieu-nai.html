<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch s·ª≠ khi·∫øu n·∫°i</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS cho Modal (C·ª≠a s·ªï chi ti·∫øt) */
        .modal {
            display: none; position: fixed; z-index: 1001; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: #fff; margin: 10% auto; padding: 30px;
            width: 90%; max-width: 650px;
            border-radius: 12px; position: relative;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        @keyframes fadeIn { from {opacity: 0; transform: translateY(-20px);} to {opacity: 1; transform: translateY(0);} }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 15px; margin-bottom: 20px;
        }
        .modal-header h2 { margin: 0; font-size: 1.5em; }
        .close-btn { color: #aaa; font-size: 32px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: #333; }
        .modal-body p { margin-bottom: 10px; }
        .modal-body strong { color: var(--text-secondary); min-width: 120px; display: inline-block; }
        #modal-noidung {
            background: #f8fafc; padding: 15px; border-radius: 8px;
            margin-top: 10px; white-space: pre-wrap;
            border: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <div th:replace="~{customer/fragments :: sidebar(activePage='lich-su-khieu-nai', khachHang=${khachHang})}"></div>

    <div class="main-content">
        <div class="card">
            <div class="header">
                <div>
                    <h1>L·ªãch s·ª≠ khi·∫øu n·∫°i</h1>
                    <p class="text-muted">Theo d√µi t·∫•t c·∫£ c√°c y√™u c·∫ßu v√† khi·∫øu n·∫°i b·∫°n ƒë√£ g·ª≠i</p>
                </div>
                 <a th:href="@{/customer/khieu-nai}" class="btn"><i class="fas fa-plus"></i> G·ª≠i khi·∫øu n·∫°i m·ªõi</a>
            </div>

            <div th:if="${danhSachKhieuNai.isEmpty()}" class="empty-state">
                <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
                <h3 style="color: #64748b;">Ch∆∞a c√≥ khi·∫øu n·∫°i n√†o</h3>
                <p class="text-muted">B·∫°n ch∆∞a g·ª≠i y√™u c·∫ßu hay khi·∫øu n·∫°i n√†o cho ch√∫ng t√¥i.</p>
            </div>

            <table th:if="${!danhSachKhieuNai.isEmpty()}">
                <thead>
                    <tr>
                        <th>M√£ KN</th>
                        <th>V·ªÅ Phi·∫øu S·ª≠a</th>
                        <th>Ti√™u ƒë·ªÅ</th>
                        <th>Ng√†y g·ª≠i</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="kn : ${danhSachKhieuNai}" class="complaint-row"
                        th:data-id="${kn.maKhieuNai}"
                        th:data-tieude="${kn.tieuDe}"
                        th:data-ngaygui="${#temporals.format(kn.ngayGui, 'dd-MM-yyyy HH:mm')}"
                        th:data-trangthai="${kn.trangThai}"
                        th:data-maphieu="${kn.phieuSuaChua.maPhieu}"
                        th:data-noidung="${kn.noiDung}">
                        <td><strong th:text="${kn.maKhieuNai}"></strong></td>
                        <td>
                            <a th:href="@{/customer/phieu-sua-chua/{id}(id=${kn.phieuSuaChua.maPhieu})}" class="link" th:text="|#${kn.phieuSuaChua.maPhieu}|"></a>
                        </td>
                        <td th:text="${kn.tieuDe}"></td>
                        <td th:text="${#temporals.format(kn.ngayGui, 'dd-MM-yyyy HH:mm')}"></td>
                        <td>
                            <span class="badge" th:classappend="${kn.trangThai == 'ƒê√£ gi·∫£i quy·∫øt'} ? 'badge-success' : (${kn.trangThai == 'ƒêang x·ª≠ l√Ω'} ? 'badge-warning' : 'badge-info')" th:text="${kn.trangThai}"></span>
                        </td>
                        <td>
                            <a href="#" class="link view-details-btn">Xem chi ti·∫øt ‚Üí</a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Chi ti·∫øt Khi·∫øu n·∫°i</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <p><strong>M√£ khi·∫øu n·∫°i:</strong> <span id="modal-id"></span></p>
                <p><strong>Ng√†y g·ª≠i:</strong> <span id="modal-ngaygui"></span></p>
                <p><strong>Tr·∫°ng th√°i:</strong> <span id="modal-trangthai"></span></p>
                <p><strong>V·ªÅ phi·∫øu s·ª≠a:</strong> <a id="modal-maphieu-link" href="#" class="link">#<span id="modal-maphieu"></span></a></p>
                <p><strong>Ti√™u ƒë·ªÅ:</strong> <span id="modal-tieude"></span></p>
                <p><strong>N·ªôi dung chi ti·∫øt:</strong></p>
                <div id="modal-noidung"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('details-modal');
            const closeBtn = document.querySelector('.close-btn');

            function openModal() { modal.style.display = 'block'; }
            function closeModal() { modal.style.display = 'none'; }

            document.querySelectorAll('.view-details-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const row = this.closest('.complaint-row');
                    const data = row.dataset;

                    document.getElementById('modal-title').innerText = `Chi ti·∫øt Khi·∫øu n·∫°i #${data.id}`;
                    document.getElementById('modal-id').innerText = data.id;
                    document.getElementById('modal-ngaygui').innerText = data.ngaygui;
                    document.getElementById('modal-trangthai').innerText = data.trangthai;
                    document.getElementById('modal-maphieu').innerText = data.maphieu;
                    document.getElementById('modal-maphieu-link').href = `/customer/phieu-sua-chua/${data.maphieu}`;
                    document.getElementById('modal-tieude').innerText = data.tieude;
                    document.getElementById('modal-noidung').innerText = data.noidung;

                    openModal();
                });
            });

            closeBtn.onclick = closeModal;
            window.onclick = function(event) {
                if (event.target == modal) {
                    closeModal();
                }
            }
        });
    </script>
</body>
</html>